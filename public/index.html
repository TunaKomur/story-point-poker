<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Story Point Poker</title>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#2b2b2b; color:#fff; }
    .layout { display:flex; height:100vh; }
    .sidebar { width:260px; background:#3a3a3a; padding:18px; box-sizing:border-box; }
    .main { flex:1; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:14px; }

    .loginBox { display:flex; flex-direction:column; gap:10px; min-width:320px; }
    input, select, button { padding:10px; border-radius:6px; border:0; outline:0; }
    button { cursor:pointer; }
    .hidden { display:none; }

    .cards {
    display:grid;
    grid-template-columns: repeat(6, 80px);
    gap:10px;
    justify-content: center;   /* âœ… kartlar ortalansÄ±n */
    }
    .card {
      width:80px; height:80px; background:#4a4a4a;
      display:flex; align-items:center; justify-content:center;
      border-radius:10px; cursor:pointer; user-select:none;
      border:2px solid transparent;
    }
    .card.selected { background:#00bcd4; }
    .controls {
        display:flex;
        justify-content: center;
        gap:20px;
        margin-top:18px;
        width:100%;
        max-width: calc(6 * 80px + 5 * 10px);
        margin-left:auto;
        margin-right:auto;
    }
    .playersTitle { font-size:18px; font-weight:bold; margin-bottom:10px; }
    .playerRow { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.15); }
    .tick { color:#00e676; font-weight:bold; }
    .adminBadge { font-size:12px; padding:2px 6px; background:#ff9800; border-radius:8px; margin-left:6px; }
    canvas { max-width:520px; max-height:320px; }
  </style>
</head>

<body>
  <div class="layout">
    <div class="sidebar">
      <div class="playersTitle">Players</div>
      <div id="playersList"></div>
    </div>

    <div class="main">
      <!-- LOGIN -->
      <div id="loginScreen" class="loginBox">
        <h2 style="margin:0 0 4px 0;">KullanÄ±cÄ± AdÄ±</h2>
        <input id="nameInput" placeholder="KullanÄ±cÄ± adÄ±:" />

        <select id="roleSelect">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>

        <button id="joinBtn">KatÄ±l</button>
        <div id="joinError" style="color:#ff5252;"></div>
      </div>

      <!-- GAME -->
      <div id="gameScreen" class="hidden">
        <h2 style="margin:0;">Story Point SeÃ§</h2>

        <div class="cards" id="cards"></div>

        <!-- sadece admin gÃ¶recek -->
        <div class="controls" id="adminControls"></div>

        <canvas id="pieChart" width="520" height="320" class="hidden"></canvas>
      </div>
    </div>
  </div>

  <script>
    const socket = io();

    const loginScreen = document.getElementById("loginScreen");
    const gameScreen = document.getElementById("gameScreen");
    const nameInput = document.getElementById("nameInput");
    const roleSelect = document.getElementById("roleSelect");
    const joinBtn = document.getElementById("joinBtn");
    const joinError = document.getElementById("joinError");

    const playersList = document.getElementById("playersList");
    const cardsDiv = document.getElementById("cards");

    const adminControls = document.getElementById("adminControls");

    const pieCanvas = document.getElementById("pieChart");
    let chart = null;

    const cardValues = ["0","1/2","1","2","3","5","8","13","20","40","100","?"];
    let myName = null;
    let myRole = "user";
    let adminTaken = false;

    // kartlarÄ± bas
    function renderCards(selectedValue = null) {
      cardsDiv.innerHTML = "";
      for (const v of cardValues) {
        const el = document.createElement("div");
        el.className = "card" + (selectedValue === v ? " selected" : "");
        el.textContent = v;
        el.onclick = () => {
          socket.emit("selectCard", v);
          // anlÄ±k UI
          document.querySelectorAll(".card").forEach(c => c.classList.remove("selected"));
          el.classList.add("selected");
        };
        cardsDiv.appendChild(el);
      }
    }

    renderCards(null);


    function renderAdminControls() {
  const adminControls = document.getElementById("adminControls");
  if (!adminControls) return;

  // Zaten eklenmiÅŸse Ã§Ä±k
  if (adminControls.querySelector("#revealBtn")) return;

  adminControls.innerHTML = `
    <button id="revealBtn">REVEAL ESTIMATES</button>
    <button id="newRoundBtn">START NEW ESTIMATION ROUND</button>
  `;

  adminControls.querySelector("#revealBtn")
    .addEventListener("click", () => socket.emit("reveal"));

  adminControls.querySelector("#newRoundBtn")
    .addEventListener("click", () => socket.emit("newRound"));
}

function removeAdminControls() {
  const adminControls = document.getElementById("adminControls");
  if (!adminControls) return;
  adminControls.innerHTML = "";
}
    // admin durumu geldiÄŸinde combobox gÃ¼ncelle
    socket.on("adminStatus", ({ adminTaken: taken, adminName: aName }) => {
      adminTaken = !!taken;

      const adminOption = [...roleSelect.options].find(o => o.value === "admin");
      if (adminOption) {
        adminOption.disabled = adminTaken;
        if (adminTaken && roleSelect.value === "admin") {
          roleSelect.value = "user";
        }
      }
    });

    joinBtn.onclick = () => {
  joinError.textContent = "";

  const name = nameInput.value.trim();
  const role = roleSelect.value;

  if (!name) {
    joinError.textContent = "Ä°sim boÅŸ olamaz.";
    return;
  }

  myName = name;
  myRole = role;

  socket.emit("join", { name, role });

  loginScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
  pieCanvas.classList.add("hidden");

  // ðŸ” KRÄ°TÄ°K NOKTA
  if (myRole === "admin") {
    renderAdminControls();
  } else {
    removeAdminControls();
  }
};


    socket.on("joinError", ({ message }) => {
      // geri dÃ¶n
      loginScreen.classList.remove("hidden");
      gameScreen.classList.add("hidden");
      joinError.textContent = message || "Join hatasÄ±";
    });

    // players list gÃ¼ncelle
    socket.on("playersUpdate", ({ players, admin }) => {
      playersList.innerHTML = "";

      for (const p of players) {
        const row = document.createElement("div");
        row.className = "playerRow";

        const left = document.createElement("div");
        left.textContent = p.name;

        if (p.role === "admin") {
          const badge = document.createElement("span");
          badge.className = "adminBadge";
          badge.textContent = "admin";
          left.appendChild(badge);
        }

        const right = document.createElement("div");
        right.innerHTML = p.selected ? '<span class="tick">âœ“</span>' : "";

        row.appendChild(left);
        row.appendChild(right);
        playersList.appendChild(row);
      }

      // ðŸ”¥ kritik: server admin'Ä± baÅŸka birine vermiÅŸ olabilir (Ã¶r: admin doluyken admin seÃ§ti)
      // Kendi rolÃ¼nÃ¼, players listesinden bulup UI'Ä± ona gÃ¶re gÃ¼ncelle
      const me = players.find(x => x.name.toLowerCase() === (myName || "").toLowerCase());
      if (me) {
        myRole = me.role;
        if (myRole === "admin") renderAdminControls();
        else removeAdminControls();
      }
    });

    socket.on("clearSelections", () => {
      renderCards(null);
      if (chart) { chart.destroy(); chart = null; }
      pieCanvas.classList.add("hidden");
    });

    socket.on("revealResults", (counts) => {
      const labels = Object.keys(counts);
      const data = Object.values(counts);

      if (!labels.length) return;

      pieCanvas.classList.remove("hidden");
      const ctx = pieCanvas.getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels,
          datasets: [{ data }]
        }
      });
    });
  </script>
</body>
</html>
